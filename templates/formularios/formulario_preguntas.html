{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}Preguntas del Formulario{% endblock %}

{% block messages %}
{% if messages %}
<div class="container mt-3">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show mensaje-alerta" role="alert"
        data-mensaje="{{ message }}">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %}
</div>

<script>
    // Eliminar mensajes duplicados
    document.addEventListener('DOMContentLoaded', function () {
        const mensajes = document.querySelectorAll('.mensaje-alerta');
        const mensajesTexto = new Set();

        mensajes.forEach(function (mensaje) {
            const textoMensaje = mensaje.getAttribute('data-mensaje');

            if (mensajesTexto.has(textoMensaje)) {
                // Si ya existe un mensaje con este texto, eliminar el duplicado
                mensaje.remove();
            } else {
                mensajesTexto.add(textoMensaje);
            }
        });
    });
</script>
{% endif %}
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row mb-4">
        <div class="col">
            <h1>Preguntas del Formulario</h1>
            <h4>{{ formulario.titulo }} - {{ formulario.curso.name }}</h4>
        </div>
    </div>

    <div class="row">
        <div class="col">
            <div class="card">
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}
                        {{ pregunta_formset.management_form }}

                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Texto de la pregunta</th>
                                        <th>Tipo</th>
                                        <th>Requerida</th>
                                        <th>Orden</th>
                                        <th>Opciones</th>
                                        <th>Eliminar</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for form in pregunta_formset.forms %}
                                    <tr class="formset-row">
                                        <td>
                                            {{ form.id }}
                                            {{ form.texto|as_crispy_field }}
                                        </td>
                                        <td>{{ form.tipo|as_crispy_field }}</td>
                                        <td>{{ form.requerida|as_crispy_field }}</td>
                                        <td>{{ form.orden|as_crispy_field }}</td>
                                        <td>
                                            {% if form.instance.pk %}
                                            <a href="{% url 'principal:pregunta_opciones' form.instance.pk %}"
                                                class="btn btn-sm btn-primary">
                                                Agregar respuestas
                                            </a>
                                            {% else %}
                                            <a href="#"
                                                onclick="guardarYRedirigir(this, '{{ formulario.id }}', '{{ forloop.counter0 }}'); return false;"
                                                class="btn btn-sm btn-primary">
                                                Agregar respuestas
                                            </a>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if form.instance.pk %}
                                            <div style="display: none;">{{ form.DELETE }}</div>
                                            <button type="button"
                                                class="btn btn-sm btn-danger eliminar-pregunta">Eliminar</button>
                                            {% else %}
                                            <button type="button"
                                                class="btn btn-sm btn-danger eliminar-pregunta">Eliminar</button>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <div class="d-flex justify-content-between mt-3">
                            <a href="{% url 'principal:formulario_list' %}" class="btn btn-secondary">Formulario de
                                Aplicación de Todos los Cursos</a>
                            <button type="button" id="add-pregunta" class="btn btn-success">Agregar Pregunta</button>
                            <button type="submit" class="btn btn-primary">Guardar Preguntas</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Esperar a que el DOM esté completamente cargado
    document.addEventListener('DOMContentLoaded', function () {
        console.clear(); // Limpiar la consola para depuración
        console.log('DOM cargado, inicializando script...');

        // Ocultar las etiquetas de los campos DELETE
        document.querySelectorAll('input[type="checkbox"][name$="-DELETE"]').forEach(function (checkbox) {
            const label = checkbox.closest('div').querySelector('label');
            if (label) {
                label.style.display = 'none';
            }
        });

        // Remover cualquier event listener existente para evitar duplicación
        const addButton = document.getElementById('add-pregunta');
        const newAddButton = addButton.cloneNode(true);
        addButton.parentNode.replaceChild(newAddButton, addButton);

        // Función para reindexar los formularios
        function reindexForms() {
            const formsetRows = document.querySelectorAll('.formset-row');
            formsetRows.forEach(function (row, index) {
                row.querySelectorAll('input, select, textarea').forEach(function (input) {
                    const name = input.getAttribute('name');
                    if (name) {
                        const newName = name.replace(/-\d+-/, `-${index}-`);
                        input.setAttribute('name', newName);

                        const id = input.getAttribute('id');
                        if (id) {
                            const newId = id.replace(/-\d+-/, `-${index}-`);
                            input.setAttribute('id', newId);
                        }
                    }
                });

                row.querySelectorAll('label').forEach(function (label) {
                    const forAttr = label.getAttribute('for');
                    if (forAttr) {
                        const newForAttr = forAttr.replace(/-\d+-/, `-${index}-`);
                        label.setAttribute('for', newForAttr);
                    }
                });
            });
        }

        // Función global para guardar y redirigir
        window.guardarYRedirigir = function (element, formularioId, formIndex) {
            // Obtener la fila que contiene este enlace
            const row = element.closest('.formset-row');

            // Obtener el texto de la pregunta para mostrar en la confirmación
            const textoInput = row.querySelector('input[name$="-texto"]');
            const textoPregunta = textoInput ? textoInput.value : 'esta pregunta';

            // Confirmar que se quiere guardar la pregunta
            if (confirm(`¿Deseas guardar "${textoPregunta}" y agregar opciones de respuesta?`)) {
                // Primero guardar el formulario principal para guardar todas las preguntas
                const mainForm = document.querySelector('form');

                // Crear un campo oculto para indicar que queremos guardar y continuar
                const hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = 'save_and_continue';
                hiddenInput.value = '1';
                mainForm.appendChild(hiddenInput);

                // Enviar el formulario principal
                mainForm.submit();
            }
        };

        // Función para eliminar una pregunta (usando delegación de eventos)
        const tbody = document.querySelector('tbody');
        const newTbody = tbody.cloneNode(true);
        tbody.parentNode.replaceChild(newTbody, tbody);

        newTbody.addEventListener('click', function (event) {
            if (event.target.classList.contains('eliminar-pregunta')) {
                console.log('Botón eliminar clickeado');
                if (confirm('¿Estás seguro de que deseas eliminar esta pregunta?')) {
                    const row = event.target.closest('.formset-row');

                    // Si la pregunta ya existe en la base de datos, marcarla para eliminar
                    const deleteCheckbox = row.querySelector('input[type="checkbox"][name$="-DELETE"]');
                    if (deleteCheckbox) {
                        deleteCheckbox.checked = true;
                        row.style.display = 'none'; // Ocultar la fila
                    } else {
                        // Si es una pregunta nueva que aún no se ha guardado, eliminarla del DOM
                        row.remove();

                        // Actualizar el contador de formularios
                        const totalForms = document.querySelector('#id_preguntas-TOTAL_FORMS');
                        totalForms.value = parseInt(totalForms.value) - 1;

                        // Reindexar los formularios restantes
                        reindexForms();
                    }
                }
            }
        });

        // Variable para evitar clics múltiples
        let isAddingQuestion = false;

        // Función para agregar una nueva pregunta
        newAddButton.addEventListener('click', function () {
            if (isAddingQuestion) {
                console.log('Ya se está procesando una adición de pregunta, ignorando clic');
                return;
            }

            isAddingQuestion = true;
            console.log('Agregando nueva pregunta...');

            // Obtener el número total de formularios actual
            const totalForms = document.querySelector('#id_preguntas-TOTAL_FORMS');
            const currentFormCount = parseInt(totalForms.value);
            console.log('Formularios actuales:', currentFormCount);

            // Clonar la última fila de pregunta
            const formsetRows = document.querySelectorAll('.formset-row');
            const lastRow = formsetRows[formsetRows.length - 1];
            const newRow = lastRow.cloneNode(true);

            // Actualizar los IDs y nombres de los campos en la nueva fila
            newRow.querySelectorAll('input, select, textarea').forEach(function (input) {
                const name = input.getAttribute('name');
                if (name) {
                    // Reemplazar el índice del formulario en el nombre
                    const newName = name.replace(/-\d+-/, `-${currentFormCount}-`);
                    input.setAttribute('name', newName);

                    // Actualizar también el ID
                    const id = input.getAttribute('id');
                    if (id) {
                        const newId = id.replace(/-\d+-/, `-${currentFormCount}-`);
                        input.setAttribute('id', newId);
                    }

                    // Limpiar el valor si no es un checkbox
                    if (input.type !== 'checkbox') {
                        input.value = '';
                    } else {
                        input.checked = false;
                    }
                }
            });

            // Actualizar también los labels
            newRow.querySelectorAll('label').forEach(function (label) {
                const forAttr = label.getAttribute('for');
                if (forAttr) {
                    const newForAttr = forAttr.replace(/-\d+-/, `-${currentFormCount}-`);
                    label.setAttribute('for', newForAttr);
                }
            });

            // Ocultar el enlace de opciones y mostrar el botón para agregar respuestas
            const opcionesCell = newRow.querySelector('td:nth-child(5)');
            if (opcionesCell) {
                // Usar un ID de formulario fijo que ya está disponible en la plantilla
                const formularioId = "{{ formulario.id }}";
                opcionesCell.innerHTML = `
                    <a href="#" onclick="guardarYRedirigir(this, '${formularioId}', ${currentFormCount}); return false;" class="btn btn-sm btn-primary">
                        Agregar respuestas
                    </a>
                `;
            }

            // Actualizar el botón eliminar en la nueva fila
            const deleteCell = newRow.querySelector('td:nth-child(6)');
            if (deleteCell) {
                deleteCell.innerHTML = '<button type="button" class="btn btn-sm btn-danger eliminar-pregunta">Eliminar</button>';
            }

            // Insertar la nueva fila en la tabla
            lastRow.parentNode.appendChild(newRow);

            // Incrementar el contador de formularios
            totalForms.value = currentFormCount + 1;
            console.log('Pregunta agregada. Nuevo total de formularios:', totalForms.value);

            // No necesitamos agregar eventos de clic a los nuevos botones "Agregar respuestas"
            // porque ahora son enlaces con onclick inline

            // Permitir nuevas adiciones después de un breve retraso
            setTimeout(function () {
                isAddingQuestion = false;
            }, 500);
        });

        console.log('Script inicializado correctamente');
    });
</script>
{% endblock %}
{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block messages %}
<!-- Intencionalmente vacío para no mostrar mensajes en esta página -->
{% endblock %}

{% block content %}
{% load crispy_forms_tags %}
{% load static %}

<style>
  /* Ocultar todos los tipos de mensajes de error que aparecen en la parte superior */
  .messages,
  .alert,
  .alert-danger,
  .alert-error,
  .alert-warning,
  .alert-info,
  .alert-block,
  .errorlist,
  .nonfield,
  ul.errorlist,
  div.alert,
  .has-error .help-block {
    display: none !important;
  }

  /* Mantener visibles solo los errores específicos de campos */
  .form-group .invalid-feedback,
  .form-group .text-danger {
    display: block !important;
  }

  /* Título principal con efectos modernos */
  .main-title {
    background: linear-gradient(135deg, #3b82f6, #1d4ed8, #1e40af) !important;
    -webkit-background-clip: text !important;
    -webkit-text-fill-color: transparent !important;
    background-clip: text !important;
    font-size: 2.5rem !important;
    font-weight: 800 !important;
    text-align: center !important;
    margin-bottom: 1rem !important;
    position: relative !important;
    text-shadow: 0 4px 8px rgba(59, 130, 246, 0.3) !important;
    letter-spacing: 1px !important;
  }

  .main-title::after {
    content: '' !important;
    position: absolute !important;
    bottom: -8px !important;
    left: 50% !important;
    transform: translateX(-50%) !important;
    width: 80px !important;
    height: 3px !important;
    background: linear-gradient(90deg, transparent, #3b82f6, transparent) !important;
    border-radius: 2px !important;
    box-shadow: 0 0 10px rgba(59, 130, 246, 0.5) !important;
  }

  /* Animación sutil para el título */
  @keyframes titleGlow {
    0%, 100% {
      text-shadow: 0 4px 8px rgba(59, 130, 246, 0.3) !important;
    }
    50% {
      text-shadow: 0 4px 20px rgba(59, 130, 246, 0.6) !important;
    }
  }

  .main-title {
    animation: titleGlow 3s ease-in-out infinite !important;
  }

  /* Responsive para el título */
  @media (max-width: 768px) {
    .main-title {
      font-size: 2rem !important;
    }
  }

  /* Tabla glassmorphism */
  .glass-table {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-radius: 16px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    box-shadow: 
      0 8px 32px rgba(0, 0, 0, 0.1),
      0 4px 16px rgba(0, 0, 0, 0.1),
      inset 0 1px 0 rgba(255, 255, 255, 0.3);
    overflow: hidden;
  }

  .glass-table table {
    background: transparent;
    border: none;
  }

  .glass-table thead th {
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(37, 99, 235, 0.1));
    color: #1e40af;
    font-weight: 600;
    border: none;
    padding: 16px 12px;
    font-size: 14px;
  }

  .glass-table tbody tr {
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    transition: all 0.3s ease;
  }

  .glass-table tbody tr:hover {
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(37, 99, 235, 0.02));
  }

  .glass-table tbody td {
    padding: 12px;
    border: none;
    vertical-align: middle;
  }

  /* Botones con glassmorphism */
  .glass-btn {
    padding: 8px 16px !important;
    border-radius: 8px !important;
    font-weight: 500 !important;
    text-decoration: none !important;
    display: inline-flex !important;
    align-items: center !important;
    justify-content: center !important;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
    border: 1px solid !important;
    cursor: pointer !important;
    font-size: 12px !important;
    position: relative !important;
    overflow: hidden !important;
    backdrop-filter: blur(15px) !important;
    -webkit-backdrop-filter: blur(15px) !important;
  }

  .glass-btn::before {
    content: '' !important;
    position: absolute !important;
    top: 0 !important;
    left: -100% !important;
    width: 100% !important;
    height: 100% !important;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent) !important;
    transition: left 0.6s ease !important;
    pointer-events: none !important;
  }

  .glass-btn:hover::before {
    left: 100% !important;
  }

  /* Botón Primario */
  .glass-btn-primary {
    background: rgba(59, 130, 246, 0.8) !important;
    background-image: linear-gradient(135deg, 
      rgba(59, 130, 246, 0.9), 
      rgba(29, 78, 216, 0.7)
    ) !important;
    color: white !important;
    border-color: rgba(147, 197, 253, 0.6) !important;
    box-shadow: 
      0 4px 16px rgba(59, 130, 246, 0.3),
      inset 0 1px 0 rgba(147, 197, 253, 0.7) !important;
  }

  .glass-btn-primary:hover {
    background: rgba(147, 197, 253, 0.9) !important;
    background-image: linear-gradient(135deg, 
      rgba(147, 197, 253, 0.8), 
      rgba(96, 165, 250, 0.6)
    ) !important;
    color: #1e40af !important;
    transform: translateY(-2px) scale(1.02) !important;
    box-shadow: 
      0 8px 24px rgba(59, 130, 246, 0.4),
      inset 0 1px 0 rgba(255, 255, 255, 0.8),
      0 0 20px rgba(59, 130, 246, 0.6) !important;
    text-decoration: none !important;
  }

  /* Botón Success */
  .glass-btn-success {
    background: rgba(16, 185, 129, 0.8) !important;
    background-image: linear-gradient(135deg, 
      rgba(16, 185, 129, 0.9), 
      rgba(5, 150, 105, 0.7)
    ) !important;
    color: white !important;
    border-color: rgba(52, 211, 153, 0.6) !important;
    box-shadow: 
      0 4px 16px rgba(16, 185, 129, 0.3),
      inset 0 1px 0 rgba(167, 243, 208, 0.7) !important;
  }

  .glass-btn-success:hover {
    background: rgba(167, 243, 208, 0.9) !important;
    background-image: linear-gradient(135deg, 
      rgba(167, 243, 208, 0.8), 
      rgba(110, 231, 183, 0.6)
    ) !important;
    color: #047857 !important;
    transform: translateY(-2px) scale(1.02) !important;
    box-shadow: 
      0 8px 24px rgba(16, 185, 129, 0.4),
      inset 0 1px 0 rgba(255, 255, 255, 0.8),
      0 0 20px rgba(16, 185, 129, 0.6) !important;
    text-decoration: none !important;
  }

  /* Botón Danger */
  .glass-btn-danger {
    background: rgba(239, 68, 68, 0.8) !important;
    background-image: linear-gradient(135deg, 
      rgba(239, 68, 68, 0.9), 
      rgba(220, 38, 38, 0.7)
    ) !important;
    color: white !important;
    border-color: rgba(248, 113, 113, 0.6) !important;
    box-shadow: 
      0 4px 16px rgba(239, 68, 68, 0.3),
      inset 0 1px 0 rgba(248, 113, 113, 0.7) !important;
  }

  .glass-btn-danger:hover {
    background: rgba(248, 113, 113, 0.9) !important;
    background-image: linear-gradient(135deg, 
      rgba(248, 113, 113, 0.8), 
      rgba(239, 68, 68, 0.6)
    ) !important;
    color: #7f1d1d !important;
    transform: translateY(-2px) scale(1.02) !important;
    box-shadow: 
      0 8px 24px rgba(239, 68, 68, 0.4),
      inset 0 1px 0 rgba(255, 255, 255, 0.8),
      0 0 20px rgba(239, 68, 68, 0.6) !important;
    text-decoration: none !important;
  }

  /* Botón Secondary */
  .glass-btn-secondary {
    background: rgba(107, 114, 128, 0.8) !important;
    background-image: linear-gradient(135deg, 
      rgba(107, 114, 128, 0.9), 
      rgba(75, 85, 99, 0.7)
    ) !important;
    color: white !important;
    border-color: rgba(156, 163, 175, 0.6) !important;
    box-shadow: 
      0 4px 16px rgba(107, 114, 128, 0.3),
      inset 0 1px 0 rgba(156, 163, 175, 0.7) !important;
  }

  .glass-btn-secondary:hover {
    background: rgba(156, 163, 175, 0.9) !important;
    background-image: linear-gradient(135deg, 
      rgba(156, 163, 175, 0.8), 
      rgba(107, 114, 128, 0.6)
    ) !important;
    color: #374151 !important;
    transform: translateY(-2px) scale(1.02) !important;
    box-shadow: 
      0 8px 24px rgba(107, 114, 128, 0.4),
      inset 0 1px 0 rgba(255, 255, 255, 0.8),
      0 0 20px rgba(107, 114, 128, 0.6) !important;
    text-decoration: none !important;
  }

  /* Campos de formulario mejorados */
  .glass-table input[type="text"],
  .glass-table textarea,
  .glass-table select {
    border: 1px solid rgba(209, 213, 219, 0.5) !important;
    border-radius: 6px !important;
    padding: 8px 12px !important;
    font-size: 14px !important;
    transition: all 0.3s ease !important;
    background-color: rgba(255, 255, 255, 0.8) !important;
    backdrop-filter: blur(10px) !important;
    -webkit-backdrop-filter: blur(10px) !important;
  }

  .glass-table input[type="text"]:focus,
  .glass-table textarea:focus,
  .glass-table select:focus {
    outline: none !important;
    border-color: #3b82f6 !important;
    background-color: rgba(239, 246, 255, 0.9) !important;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1) !important;
  }

  /* Checkbox personalizado */
  .glass-table input[type="checkbox"] {
    appearance: none !important;
    -webkit-appearance: none !important;
    width: 18px !important;
    height: 18px !important;
    border: 2px solid #d1d5db !important;
    border-radius: 4px !important;
    background-color: rgba(255, 255, 255, 0.8) !important;
    cursor: pointer !important;
    position: relative !important;
    transition: all 0.3s ease !important;
  }

  .glass-table input[type="checkbox"]:checked {
    background: linear-gradient(135deg, #3b82f6, #1d4ed8) !important;
    border-color: #1d4ed8 !important;
  }

  .glass-table input[type="checkbox"]:checked::after {
    content: '✓' !important;
    position: absolute !important;
    top: 50% !important;
    left: 50% !important;
    transform: translate(-50%, -50%) !important;
    color: white !important;
    font-size: 12px !important;
    font-weight: bold !important;
  }

  /* Contenedor de acciones */
  .form-actions {
    display: flex !important;
    flex-wrap: wrap !important;
    gap: 12px !important;
    align-items: center !important;
    justify-content: space-between !important;
    margin-top: 24px !important;
    padding: 20px !important;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.2);
  }

  .form-actions .left-actions {
    display: flex !important;
    gap: 12px !important;
    flex-wrap: wrap !important;
  }

  .form-actions .right-actions {
    display: flex !important;
    gap: 12px !important;
    flex-wrap: wrap !important;
  }

  /* Responsive para botones */
  @media (max-width: 768px) {
    .form-actions {
      flex-direction: column !important;
      align-items: stretch !important;
    }
    
    .form-actions .left-actions,
    .form-actions .right-actions {
      justify-content: center !important;
    }
    
    .glass-btn {
      width: 100% !important;
      justify-content: center !important;
    }
  }

  /* Modal glassmorphism */
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
  }

  .modal-overlay.show {
    opacity: 1;
    visibility: visible;
  }

  .modal-content {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(255, 255, 255, 0.85));
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-radius: 16px;
    border: 1px solid rgba(255, 255, 255, 0.3);
    box-shadow: 
      0 20px 60px rgba(0, 0, 0, 0.2),
      0 8px 32px rgba(0, 0, 0, 0.1),
      inset 0 1px 0 rgba(255, 255, 255, 0.4);
    padding: 32px;
    max-width: 400px;
    width: 90%;
    transform: scale(0.8) translateY(20px);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .modal-overlay.show .modal-content {
    transform: scale(1) translateY(0);
  }

  .modal-header {
    display: flex;
    align-items: center;
    margin-bottom: 20px;
  }

  .modal-icon {
    width: 48px;
    height: 48px;
    background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(220, 38, 38, 0.1));
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 16px;
    border: 1px solid rgba(239, 68, 68, 0.3);
  }

  .modal-icon svg {
    width: 24px;
    height: 24px;
    color: #dc2626;
  }

  .modal-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: #374151;
    margin: 0;
  }

  .modal-message {
    color: #6b7280;
    font-size: 14px;
    line-height: 1.5;
    margin-bottom: 24px;
  }

  .modal-actions {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
  }

  .modal-btn {
    padding: 10px 20px;
    border-radius: 8px;
    font-weight: 500;
    font-size: 14px;
    border: none;
    cursor: pointer;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 80px;
  }

  .modal-btn-cancel {
    background: rgba(107, 114, 128, 0.1);
    color: #6b7280;
    border: 1px solid rgba(107, 114, 128, 0.3);
  }

  .modal-btn-cancel:hover {
    background: rgba(107, 114, 128, 0.2);
    color: #374151;
    transform: translateY(-1px);
  }

  .modal-btn-delete {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    color: white;
    border: 1px solid rgba(239, 68, 68, 0.3);
    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
  }

  .modal-btn-delete:hover {
    background: linear-gradient(135deg, #dc2626, #b91c1c);
    transform: translateY(-1px);
    box-shadow: 0 6px 16px rgba(239, 68, 68, 0.4);
  }

  /* Animación de entrada */
  @keyframes modalFadeIn {
    from {
      opacity: 0;
      transform: scale(0.8) translateY(20px);
    }
    to {
      opacity: 1;
      transform: scale(1) translateY(0);
    }
  }

  /* Responsive para modal */
  @media (max-width: 768px) {
    .modal-content {
      padding: 24px;
      margin: 20px;
    }
    
    .modal-actions {
      flex-direction: column;
    }
    
    .modal-btn {
      width: 100%;
    }
  }
</style>

<div class="container mx-auto px-4">
  <h1 class="main-title">PREGUNTAS DEL FORMULARIO</h1>
</div>
<hr class="border-gray-300 mb-6">

<div class="max-w-7xl mx-auto px-4 py-8">
  <div class="text-center mb-6">
    <h5 class="text-xl font-semibold mb-2">Formulario de aplicación al curso</h5>
    <p class="text-lg text-blue-600 font-medium">{{ formulario.curso.name }}</p>
  </div>

  <form method="post" class="space-y-6">
    {% csrf_token %}
    {{ pregunta_formset.management_form }}
    
    <div class="glass-table">
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead>
            <tr>
              <th class="text-left" style="width: 35%;">Texto de la pregunta</th>
              <th class="text-left" style="width: 20%;">Tipo</th>
              <th class="text-center" style="width: 10%;">Requerida</th>
              <th class="text-center" style="width: 10%;">Orden</th>
              <th class="text-center" style="width: 15%;">Opciones</th>
              <th class="text-center" style="width: 10%;">Eliminar</th>
            </tr>
          </thead>
          <tbody>
            {% for form in pregunta_formset.forms %}
            <tr class="formset-row">
              <td>
                {{ form.id }}
                {{ form.texto|as_crispy_field }}
              </td>
              <td>{{ form.tipo|as_crispy_field }}</td>
              <td class="text-center">{{ form.requerida|as_crispy_field }}</td>
              <td class="text-center">{{ form.orden|as_crispy_field }}</td>
              <td class="text-center">
                {% if form.instance.pk %}
                  {% if form.instance.tipo != 'escritura_libre' %}
                  <a href="{% url 'principal:pregunta_opciones' form.instance.pk %}"
                      class="glass-btn glass-btn-primary btn-agregar-respuestas">
                      <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.5v15m7.5-7.5h-15"></path>
                      </svg>
                      Agregar
                  </a>
                  {% else %}
                  <span class="text-gray-500 text-sm">No requiere opciones</span>
                  {% endif %}
                {% else %}
                  <a href="#"
                      onclick="guardarYRedirigir(this, '{{ formulario.id }}', '{{ forloop.counter0 }}'); return false;"
                      class="glass-btn glass-btn-primary btn-agregar-respuestas">
                      <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.5v15m7.5-7.5h-15"></path>
                      </svg>
                      Agregar
                  </a>
                {% endif %}
              </td>
              <td class="text-center">
                {% if form.instance.pk %}
                <div style="display: none;">{{ form.DELETE }}</div>
                <button type="button" class="glass-btn glass-btn-danger eliminar-pregunta">
                  <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0"></path>
                  </svg>
                  Eliminar
                </button>
                {% else %}
                <button type="button" class="glass-btn glass-btn-danger eliminar-pregunta">
                  <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0"></path>
                  </svg>
                  Eliminar
                </button>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <div class="form-actions">
      <div class="left-actions">
        <a href="{% url 'principal:formulario_list' %}" class="glass-btn glass-btn-secondary">
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.5 19.5 3 12m0 0 7.5-7.5M3 12h18"></path>
          </svg>
          Volver a Formularios
        </a>
      </div>
      
      <div class="right-actions">
        <button type="button" id="add-pregunta" class="glass-btn glass-btn-success">
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.5v15m7.5-7.5h-15"></path>
          </svg>
          Agregar Pregunta
        </button>
        <button type="submit" class="glass-btn glass-btn-primary">
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.593 3.322c1.1.128 1.907 1.077 1.907 2.185V21L12 17.25 4.5 21V5.507c0-1.108.806-2.057 1.907-2.185a48.507 48.507 0 0 1 11.186 0Z"></path>
          </svg>
          Guardar Preguntas
        </button>
      </div>
    </div>
  </form>
</div>

<!-- Modal de confirmación para eliminar pregunta -->
<div id="deleteModal" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-icon">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
        </svg>
      </div>
      <h3 class="modal-title">Confirmar eliminación</h3>
    </div>
    <div class="modal-message">
      ¿Estás seguro de que deseas eliminar esta pregunta? Esta acción no se puede deshacer.
    </div>
    <div class="modal-actions">
      <button type="button" class="modal-btn modal-btn-cancel" onclick="closeDeleteModal()">
        Cancelar
      </button>
      <button type="button" class="modal-btn modal-btn-delete" onclick="window.confirmDelete()">
        Eliminar
      </button>
    </div>
  </div>
</div>

<script>
    // Variable global para almacenar la fila que se va a eliminar
    let rowToDelete = null;

    // Esperar a que el DOM esté completamente cargado
    document.addEventListener('DOMContentLoaded', function () {
        console.clear(); // Limpiar la consola para depuración
        console.log('DOM cargado, inicializando script...');

        // Ocultar la primera fila al cargar la página, excepto si viene de agregar respuestas
        const addNew = false; // Default to false for now
        const formsetRows = document.querySelectorAll('.formset-row');
        if (formsetRows.length > 0 && !addNew) {
            // Solo ocultar si no hay preguntas guardadas (verificar si tiene ID) y no viene de add_new
            const firstRow = formsetRows[0];
            const idField = firstRow.querySelector('input[name$="-id"]');
            if (!idField || !idField.value) {
                firstRow.style.display = 'none';
                console.log('Primera fila oculta al cargar la página');
            }
        } else if (addNew && formsetRows.length > 0) {
            // Si viene de add_new, asegurarse de que la última fila (nueva) esté visible
            const lastRow = formsetRows[formsetRows.length - 1];
            lastRow.style.display = '';
            console.log('Mostrando nueva fila porque viene de add_new');
        }

        // Ocultar las etiquetas de los campos DELETE
        document.querySelectorAll('input[type="checkbox"][name$="-DELETE"]').forEach(function (checkbox) {
            const label = checkbox.closest('div').querySelector('label');
            if (label) {
                label.style.display = 'none';
            }
        });

        // Remover cualquier event listener existente para evitar duplicación
        const addButton = document.getElementById('add-pregunta');
        const newAddButton = addButton.cloneNode(true);
        addButton.parentNode.replaceChild(newAddButton, addButton);

        // Función para reindexar los formularios
        function reindexForms() {
            const formsetRows = document.querySelectorAll('.formset-row');
            formsetRows.forEach(function (row, index) {
                row.querySelectorAll('input, select, textarea').forEach(function (input) {
                    const name = input.getAttribute('name');
                    if (name) {
                        const newName = name.replace(/-\d+-/, `-${index}-`);
                        input.setAttribute('name', newName);

                        const id = input.getAttribute('id');
                        if (id) {
                            const newId = id.replace(/-\d+-/, `-${index}-`);
                            input.setAttribute('id', newId);
                        }
                    }
                });

                row.querySelectorAll('label').forEach(function (label) {
                    const forAttr = label.getAttribute('for');
                    if (forAttr) {
                        const newForAttr = forAttr.replace(/-\d+-/, `-${index}-`);
                        label.setAttribute('for', newForAttr);
                    }
                });
            });
        }

        // Función para actualizar la visibilidad del botón "Agregar respuestas" según el tipo de pregunta
        function updateAgregarRespuestasButton(row) {
            console.log('Actualizando botón para fila:', row);

            const tipoSelect = row.querySelector('select[name$="-tipo"]');
            if (!tipoSelect) {
                console.log('No se encontró selector de tipo en la fila');
                return;
            }

            console.log('Tipo seleccionado:', tipoSelect.value);

            // Buscar la celda de opciones (5ta columna)
            const opcionesCell = row.querySelector('td:nth-child(5)');
            if (!opcionesCell) {
                console.log('No se encontró celda de opciones');
                return;
            }

            // Buscar cualquier botón de agregar respuestas en la celda
            let agregarRespuestasBtn = opcionesCell.querySelector('.btn-agregar-respuestas');
            if (!agregarRespuestasBtn) {
                // Si no tiene la clase específica, buscar cualquier botón primario
                agregarRespuestasBtn = opcionesCell.querySelector('a.glass-btn-primary');

                // Si se encuentra, añadirle la clase para futuras referencias
                if (agregarRespuestasBtn) {
                    agregarRespuestasBtn.classList.add('btn-agregar-respuestas');
                }
            }

            if (!agregarRespuestasBtn) {
                console.log('No se encontró botón de agregar respuestas');
                return;
            }

            console.log('Botón encontrado:', agregarRespuestasBtn);

            if (tipoSelect.value === 'escritura_libre') {
                // Si es escritura libre, ocultar el botón y mostrar un mensaje
                agregarRespuestasBtn.style.display = 'none';

                // Crear un mensaje si no existe
                let mensaje = opcionesCell.querySelector('.text-gray-500');
                if (!mensaje) {
                    mensaje = document.createElement('span');
                    mensaje.className = 'text-gray-500 text-sm';
                    mensaje.textContent = 'No requiere opciones';
                    opcionesCell.appendChild(mensaje);
                } else {
                    mensaje.style.display = 'inline';
                }

                console.log('Ocultando botón y mostrando mensaje');
            } else {
                // Si es selección múltiple o única, mostrar el botón y ocultar el mensaje
                agregarRespuestasBtn.style.display = 'inline-block';

                const mensaje = opcionesCell.querySelector('.text-gray-500');
                if (mensaje) {
                    mensaje.style.display = 'none';
                }

                console.log('Mostrando botón y ocultando mensaje');
            }
        }

        // Función para inicializar los selectores de tipo
        function initTipoSelectors() {
            console.log('Inicializando selectores de tipo...');

            // Procesar cada fila del formulario
            document.querySelectorAll('.formset-row').forEach(function (row, index) {
                console.log(`Procesando fila ${index}...`);

                // Encontrar el selector de tipo en esta fila
                const tipoSelect = row.querySelector('select[name$="-tipo"]');
                if (!tipoSelect) {
                    console.log(`No se encontró selector de tipo en la fila ${index}`);
                    return;
                }

                // Eliminar event listeners existentes para evitar duplicados
                const newSelect = tipoSelect.cloneNode(true);
                tipoSelect.parentNode.replaceChild(newSelect, tipoSelect);

                // Añadir nuevo event listener
                newSelect.addEventListener('change', function () {
                    console.log(`Cambio en selector de tipo de fila ${index}, nuevo valor: ${this.value}`);
                    updateAgregarRespuestasButton(row);
                });

                // Asegurarse de que todos los botones en la fila tengan la clase correcta
                const opcionesCell = row.querySelector('td:nth-child(5)');
                if (opcionesCell) {
                    const btnPrimary = opcionesCell.querySelector('a.glass-btn-primary');
                    if (btnPrimary && !btnPrimary.classList.contains('btn-agregar-respuestas')) {
                        btnPrimary.classList.add('btn-agregar-respuestas');
                        console.log(`Añadida clase btn-agregar-respuestas a botón en fila ${index}`);
                    }
                }

                // Actualizar el estado inicial
                console.log(`Actualizando estado inicial de fila ${index}, valor: ${newSelect.value}`);
                updateAgregarRespuestasButton(row);
            });

            console.log('Inicialización de selectores completada');
        }

        // Inicializar los selectores de tipo al cargar la página
        // Asegurarse de que el DOM esté completamente cargado
        function initializeAll() {
            console.log('Inicializando todos los componentes...');

            // Primero inicializar los selectores de tipo
            initTipoSelectors();

            // Luego procesar manualmente cada fila para asegurarnos de que los botones se muestren/oculten correctamente
            document.querySelectorAll('.formset-row').forEach(function (row, index) {
                const tipoSelect = row.querySelector('select[name$="-tipo"]');
                if (tipoSelect && tipoSelect.value === 'escritura_libre') {
                    console.log(`Fila ${index} tiene tipo escritura_libre, ocultando botón...`);

                    // Buscar el botón en esta fila
                    const opcionesCell = row.querySelector('td:nth-child(5)');
                    if (opcionesCell) {
                        const btn = opcionesCell.querySelector('a.glass-btn-primary');
                        if (btn) {
                            btn.style.display = 'none';

                            // Crear mensaje si no existe
                            if (!opcionesCell.querySelector('.text-muted')) {
                                const mensaje = document.createElement('span');
                                mensaje.className = 'text-gray-500 text-sm';
                                mensaje.textContent = 'No requiere opciones';
                                opcionesCell.appendChild(mensaje);
                            }
                        }
                    }
                }
            });

            console.log('Inicialización completa');
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function () {
                console.log('DOM cargado, inicializando componentes...');
                setTimeout(initializeAll, 100);
            });
        } else {
            console.log('DOM ya cargado, inicializando componentes...');
            setTimeout(initializeAll, 100);
        }

        // Función global para guardar y redirigir
        window.guardarYRedirigir = function (element, formularioId, formIndex) {
            // Obtener la fila que contiene este enlace
            const row = element.closest('.formset-row');

            // Obtener el texto de la pregunta para mostrar en la confirmación
            const textoInput = row.querySelector('input[name$="-texto"]');
            const textoPregunta = textoInput ? textoInput.value : 'esta pregunta';

            // Confirmar que se quiere guardar la pregunta
            if (confirm(`¿Deseas guardar "${textoPregunta}" y agregar opciones de respuesta?`)) {
                // Primero guardar el formulario principal para guardar todas las preguntas
                const mainForm = document.querySelector('form');

                // Crear un campo oculto para indicar que queremos guardar y continuar
                const hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = 'save_and_continue';
                hiddenInput.value = '1';
                mainForm.appendChild(hiddenInput);

                // Enviar el formulario principal
                mainForm.submit();
            }
        };

        // Función para eliminar una pregunta (usando delegación de eventos)
        const tbody = document.querySelector('tbody');
        const newTbody = tbody.cloneNode(true);
        tbody.parentNode.replaceChild(newTbody, tbody);

        newTbody.addEventListener('click', function (event) {
            if (event.target.classList.contains('eliminar-pregunta')) {
                console.log('Botón eliminar clickeado');
                rowToDelete = event.target.closest('.formset-row');
                showDeleteModal();
            }
        });

        // Variable para evitar clics múltiples
        let isAddingQuestion = false;

        // Función para agregar una nueva pregunta
        newAddButton.addEventListener('click', function () {
            if (isAddingQuestion) {
                console.log('Ya se está procesando una adición de pregunta, ignorando clic');
                return;
            }

            isAddingQuestion = true;
            console.log('Agregando nueva pregunta...');

            // Obtener el número total de formularios actual
            const totalForms = document.querySelector('#id_preguntas-TOTAL_FORMS');
            const currentFormCount = parseInt(totalForms.value);
            console.log('Formularios actuales:', currentFormCount);

            // Verificar si hay filas visibles
            const visibleRows = Array.from(document.querySelectorAll('.formset-row')).filter(row => row.style.display !== 'none');
            
            if (visibleRows.length === 0) {
                // Si no hay filas visibles, mostrar la primera fila oculta
                const firstRow = document.querySelector('.formset-row:first-child');
                if (firstRow) {
                    // Mostrar la fila
                    firstRow.style.display = '';
                    console.log('Mostrando la primera fila oculta');
                    
                    // Limpiar los campos de la primera fila
                    firstRow.querySelectorAll('input[type="text"], textarea').forEach(function(input) {
                        input.value = '';
                    });
                    
                    // Asegurarse de que el checkbox requerida esté marcado
                    const requeridaCheckbox = firstRow.querySelector('input[name$="-requerida"]');
                    if (requeridaCheckbox) {
                        requeridaCheckbox.checked = true;
                    }
                    
                    // Asegurarse de que el campo orden tenga un valor correcto
                    const ordenInput = firstRow.querySelector('input[name$="-orden"]');
                    if (ordenInput) {
                        // Calcular el siguiente orden disponible
                        let maxOrden = -1;
                        document.querySelectorAll('input[name$="-orden"]').forEach(function(input) {
                            if (input !== ordenInput) { // Excluir el input actual
                                const valor = parseInt(input.value) || 0;
                                if (valor > maxOrden) {
                                    maxOrden = valor;
                                }
                            }
                        });
                        const siguienteOrden = maxOrden + 1;
                        ordenInput.value = siguienteOrden.toString();
                    }
                    
                    // Permitir nuevas adiciones después de un breve retraso
                    setTimeout(function () {
                        isAddingQuestion = false;
                    }, 500);
                    return;
                }
            }

            // Clonar la última fila de pregunta
            const formsetRows = document.querySelectorAll('.formset-row');
            const lastRow = formsetRows[formsetRows.length - 1];
            const newRow = lastRow.cloneNode(true);

            // Actualizar los IDs y nombres de los campos en la nueva fila
            newRow.querySelectorAll('input, select, textarea').forEach(function (input) {
                const name = input.getAttribute('name');
                if (name) {
                    // Reemplazar el índice del formulario en el nombre
                    const newName = name.replace(/-\d+-/, `-${currentFormCount}-`);
                    input.setAttribute('name', newName);

                    // Actualizar también el ID
                    const id = input.getAttribute('id');
                    if (id) {
                        const newId = id.replace(/-\d+-/, `-${currentFormCount}-`);
                        input.setAttribute('id', newId);
                    }

                    // Limpiar el valor si no es un checkbox o el campo orden
                    if (input.type !== 'checkbox' && !name.includes('-orden')) {
                        input.value = '';
                    } else if (input.type === 'checkbox') {
                        // Solo desmarcar el checkbox DELETE, mantener marcado el checkbox requerida
                        if (name.includes('-DELETE')) {
                            input.checked = false;
                        } else if (name.includes('-requerida')) {
                            input.checked = true; // Mantener marcado por defecto
                        }
                    }

                    // Establecer un valor para el campo orden basado en el máximo orden existente + 1
                    if (name && name.includes('-orden')) {
                        // Calcular el siguiente orden disponible
                        let maxOrden = -1;
                        document.querySelectorAll('input[name$="-orden"]').forEach(function(ordenInput) {
                            const valor = parseInt(ordenInput.value) || 0;
                            if (valor > maxOrden) {
                                maxOrden = valor;
                            }
                        });
                        const siguienteOrden = maxOrden + 1;
                        
                        input.value = siguienteOrden;
                        input.setAttribute('value', siguienteOrden);
                        input.style.width = '80px';
                    }

                    // Asegurarse de que el campo de texto tenga 3 líneas
                    if (name && name.includes('-texto')) {
                        if (input.tagName.toLowerCase() === 'textarea') {
                            input.setAttribute('rows', '3');
                        }
                    }

                    // Ajustar el ancho del selector de tipo
                    if (name && name.includes('-tipo') && input.tagName.toLowerCase() === 'select') {
                        input.style.width = '100%';
                    }
                }
            });

            // Actualizar también los labels
            newRow.querySelectorAll('label').forEach(function (label) {
                const forAttr = label.getAttribute('for');
                if (forAttr) {
                    const newForAttr = forAttr.replace(/-\d+-/, `-${currentFormCount}-`);
                    label.setAttribute('for', newForAttr);
                }
            });

            // Ocultar el enlace de opciones y mostrar el botón para agregar respuestas
            const opcionesCell = newRow.querySelector('td:nth-child(5)');
            if (opcionesCell) {
                // Usar un ID de formulario fijo que ya está disponible en la plantilla
                const formularioId = "{{ formulario.id }}";
                opcionesCell.innerHTML = `
                    <a href="#" onclick="guardarYRedirigir(this, '${formularioId}', ${currentFormCount}); return false;" class="glass-btn glass-btn-primary btn-agregar-respuestas">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.5v15m7.5-7.5h-15"></path>
                        </svg>
                        Agregar
                    </a>
                `;
            }

            // Actualizar el botón eliminar en la nueva fila
            const deleteCell = newRow.querySelector('td:nth-child(6)');
            if (deleteCell) {
                deleteCell.innerHTML = `
                    <button type="button" class="glass-btn glass-btn-danger eliminar-pregunta">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0"></path>
                        </svg>
                        Eliminar
                    </button>
                `;
            }

            // Insertar la nueva fila en la tabla
            lastRow.parentNode.appendChild(newRow);

            // Incrementar el contador de formularios
            totalForms.value = currentFormCount + 1;
            console.log('Pregunta agregada. Nuevo total de formularios:', totalForms.value);

            // Añadir event listener para el selector de tipo en la nueva fila
            const newTipoSelect = newRow.querySelector('select[name$="-tipo"]');
            if (newTipoSelect) {
                console.log('Configurando nuevo selector de tipo para la fila añadida');

                newTipoSelect.addEventListener('change', function () {
                    console.log('Cambio en selector de tipo de nueva fila, nuevo valor:', this.value);
                    const row = this.closest('.formset-row');
                    updateAgregarRespuestasButton(row);
                });

                // Asegurarse de que el botón tenga la clase correcta
                const opcionesCell = newRow.querySelector('td:nth-child(5)');
                if (opcionesCell) {
                    const btnPrimary = opcionesCell.querySelector('a.glass-btn-primary');
                    if (btnPrimary && !btnPrimary.classList.contains('btn-agregar-respuestas')) {
                        btnPrimary.classList.add('btn-agregar-respuestas');
                        console.log('Añadida clase btn-agregar-respuestas a botón en nueva fila');
                    }
                }

                // Actualizar el estado inicial
                console.log('Actualizando estado inicial de nueva fila, valor:', newTipoSelect.value);
                updateAgregarRespuestasButton(newRow);
            }

            // Permitir nuevas adiciones después de un breve retraso
            setTimeout(function () {
                isAddingQuestion = false;
            }, 500);
        });

        console.log('Script inicializado correctamente');
    });

    // Funciones del modal de eliminación (fuera del DOMContentLoaded para acceso global)
    function showDeleteModal() {
        const modal = document.getElementById('deleteModal');
        modal.classList.add('show');
        
        // Prevenir scroll del body
        document.body.style.overflow = 'hidden';
        
        // Cerrar modal con Escape
        document.addEventListener('keydown', handleEscapeKey);
        
        // Cerrar modal al hacer clic fuera
        modal.addEventListener('click', handleOutsideClick);
    }

    function closeDeleteModal() {
        // Obtener el modal
        const modal = document.getElementById('deleteModal');
        if (!modal) {
            return;
        }
        
        // Remover la clase show para ocultar el modal
        modal.classList.remove('show');
        
        // Restaurar scroll del body
        document.body.style.overflow = '';
        
        // Remover event listeners de forma segura
        try {
            document.removeEventListener('keydown', handleEscapeKey);
            modal.removeEventListener('click', handleOutsideClick);
        } catch (e) {
            // Silenciar errores de event listeners
        }
        
        // Limpiar la referencia a la fila
        rowToDelete = null;
    }

    function confirmDelete() {
        if (rowToDelete) {
            // Si la pregunta ya existe en la base de datos, marcarla para eliminar
            const deleteCheckbox = rowToDelete.querySelector('input[type="checkbox"][name$="-DELETE"]');
            if (deleteCheckbox) {
                deleteCheckbox.checked = true;
                rowToDelete.style.display = 'none'; // Ocultar la fila
            } else {
                // Si es una pregunta nueva que aún no se ha guardado, eliminarla del DOM
                rowToDelete.remove();

                // Actualizar el contador de formularios
                const totalForms = document.querySelector('#id_preguntas-TOTAL_FORMS');
                if (totalForms) {
                    totalForms.value = parseInt(totalForms.value) - 1;
                }

                // Reindexar los formularios restantes
                if (typeof reindexForms === 'function') {
                    reindexForms();
                }
            }
        }
        
        closeDeleteModal();
    }

    function handleEscapeKey(event) {
        if (event.key === 'Escape') {
            closeDeleteModal();
        }
    }

    function handleOutsideClick(event) {
        if (event.target === event.currentTarget) {
            closeDeleteModal();
        }
    }

    // Hacer las funciones globales para que puedan ser llamadas desde los botones
    window.showDeleteModal = showDeleteModal;
    window.closeDeleteModal = closeDeleteModal;
    window.confirmDelete = confirmDelete;
</script>
{% endblock %}